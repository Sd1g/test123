<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UML Process Visualizer</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }
        
        h1 {
            text-align: center;
            padding: 40px 0 30px;
            font-size: 2.5rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .input-section {
            padding: 40px;
            border-bottom: 2px solid rgba(102, 126, 234, 0.1);
        }
        
        .test-buttons {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 30px;
        }
        
        @media (max-width: 768px) {
            .test-buttons { grid-template-columns: 1fr; }
        }
        
        .test-btn {
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
        }
        
        textarea {
            width: 100%;
            min-height: 150px;
            padding: 20px;
            border: 2px solid rgba(102, 126, 234, 0.3);
            border-radius: 12px;
            font-size: 16px;
            resize: vertical;
            margin-bottom: 30px;
            background: white;
        }
        
        .main-buttons {
            display: flex;
            gap: 20px;
            justify-content: center;
        }
        
        .process-btn, .reset-btn {
            padding: 15px 40px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
        }
        
        .process-btn {
            background: #00b09b;
            color: white;
        }
        
        .reset-btn {
            background: #ff416c;
            color: white;
        }
        
        .progress-section {
            margin: 20px 0;
            display: none;
        }
        
        .progress-bar {
            width: 100%;
            height: 20px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 15px;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2, #00b09b);
            width: 0%;
            transition: width 0.5s;
        }
        
        .error-section {
            background: rgba(255, 65, 108, 0.1);
            color: #ff416c;
            border: 2px solid #ff416c;
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            display: none;
        }
        
        .close-error {
            float: right;
            background: none;
            border: none;
            color: #ff416c;
            cursor: pointer;
            font-size: 24px;
        }
        
        .results-section {
            padding: 40px;
        }
        
        .result-card {
            margin-bottom: 40px;
            display: none;
        }
        
        .result-card h2 {
            margin-bottom: 20px;
            color: #2c3e50;
            font-size: 1.5rem;
            padding-bottom: 10px;
            border-bottom: 2px solid rgba(102, 126, 234, 0.2);
        }
        
        /* ПРОСТЫЕ ДИАГРАММЫ */
        .simple-diagram {
            background: white;
            border: 2px solid #667eea;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            overflow-x: auto;
        }
        
        /* PlantUML диаграмма - БОЛЬШАЯ И ПРОСТАЯ */
        .plantuml-container {
            width: 100%;
            min-height: 400px;
            background: white;
            border-radius: 8px;
            padding: 20px;
            overflow: auto;
            text-align: center;
        }
        
        .plantuml-image {
            max-width: 100%;
            height: auto;
            min-width: 600px;
        }
        
        /* Простая таблица для heatmap */
        .simple-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        
        .simple-table th,
        .simple-table td {
            padding: 15px;
            text-align: center;
            border: 1px solid #ddd;
        }
        
        .simple-table th {
            background: #667eea;
            color: white;
            font-weight: bold;
        }
        
        .simple-table td {
            background: #f0f5ff;
        }
        
        .highlight-cell {
            background: #ff416c !important;
            color: white;
            font-weight: bold;
        }
        
        /* Простая блок-схема */
        .flow-diagram {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            padding: 20px;
        }
        
        .flow-step {
            background: #667eea;
            color: white;
            padding: 15px 30px;
            border-radius: 8px;
            text-align: center;
            min-width: 200px;
            font-weight: bold;
        }
        
        .flow-arrow {
            color: #667eea;
            font-size: 24px;
        }
        
        .flow-branch {
            display: flex;
            gap: 40px;
            margin: 20px 0;
        }
        
        .flow-condition {
            background: #ff416c;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            font-style: italic;
        }
        
        /* Подсветка текста */
        .highlighted-text {
            padding: 20px;
            background: #f5f7fa;
            border-radius: 12px;
            font-size: 18px;
            line-height: 1.6;
        }
        
        .entity {
            padding: 5px 10px;
            margin: 3px;
            border-radius: 5px;
            display: inline-block;
            font-weight: 600;
            color: white;
        }
        
        .entity-agent { background: #667eea; }
        .entity-task { background: #00b09b; }
        .entity-condition { background: #ff416c; }
        
        /* Адаптивность */
        @media (max-width: 768px) {
            .input-section, .results-section { padding: 20px; }
            h1 { font-size: 2rem; }
            .main-buttons { flex-direction: column; }
            .process-btn, .reset-btn { width: 100%; }
            .flow-branch { flex-direction: column; }
            .simple-table { font-size: 14px; }
            .simple-table th, 
            .simple-table td { padding: 10px; }
            .plantuml-image { min-width: 400px; }
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/pako@2.1.0/dist/pako.min.js"></script>
</head>
<body>
    <div class="container">
        <div class="glass-card">
            <h1>UML Process Visualizer</h1>
            
            <div class="input-section">
                <div class="test-buttons">
                    <button class="test-btn" data-test="1">Test 1: Simple Process</button>
                    <button class="test-btn" data-test="2">Test 2: Conditional Process</button>
                    <button class="test-btn" data-test="3">Test 3: Complex Process</button>
                </div>
                
                <textarea id="process-text" placeholder="Describe your business process here..."></textarea>
                
                <div class="main-buttons">
                    <button id="process-btn" class="process-btn">Process Text</button>
                    <button id="reset-btn" class="reset-btn">Reset All</button>
                </div>
                
                <div class="progress-section" id="progress-section">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progress-fill"></div>
                    </div>
                    <div id="progress-text">Processing...</div>
                </div>
                
                <div class="error-section" id="error-section">
                    <button class="close-error" id="close-error">×</button>
                    <div id="error-message"></div>
                </div>
            </div>
            
            <div class="results-section">
                <div id="result-highlighting" class="result-card">
                    <h2>Text Analysis</h2>
                    <div id="highlighted-text" class="highlighted-text"></div>
                </div>
                
                <div id="result-plantuml" class="result-card">
                    <h2>Process Flow (UML)</h2>
                    <div id="plantuml-diagram" class="simple-diagram">
                        <div class="plantuml-container">
                            <!-- PlantUML будет здесь -->
                        </div>
                    </div>
                </div>
                
                <div id="result-heatmap" class="result-card">
                    <h2>Interaction Matrix</h2>
                    <div id="simple-heatmap" class="simple-diagram"></div>
                </div>
                
                <div id="result-flow" class="result-card">
                    <h2>Process Steps</h2>
                    <div id="simple-flow" class="simple-diagram"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const testCases = {
            1: `Employee submits a vacation request. Manager reviews the request. If approved, HR department processes the vacation. Otherwise, manager informs the employee.`,
            2: `Customer submits a product return request. Support service checks the request. If product meets return conditions, finance department approves refund. Otherwise, support service informs customer about rejection.`,
            3: `Customer sends development request. Project manager analyzes the request. Sales department prepares commercial proposal. Development department starts work. Testers verify result.`
        };

        // Initialize
        document.querySelectorAll('.test-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.getElementById('process-text').value = testCases[this.dataset.test];
            });
        });

        document.getElementById('process-btn').addEventListener('click', processText);
        document.getElementById('reset-btn').addEventListener('click', resetApp);
        document.getElementById('close-error').addEventListener('click', () => {
            document.getElementById('error-section').style.display = 'none';
        });

        // Main processing function
        async function processText() {
            const text = document.getElementById('process-text').value.trim();
            if (!text) return showError('Please enter process text');
            
            resetResults();
            document.getElementById('progress-section').style.display = 'block';
            
            try {
                await simulateProgress();
                generateResults(text);
                scrollToResults();
            } catch (err) {
                showError(err.message);
            } finally {
                document.getElementById('progress-section').style.display = 'none';
            }
        }

        // Progress simulation
        async function simulateProgress() {
            const fill = document.getElementById('progress-fill');
            const text = document.getElementById('progress-text');
            const steps = [
                {p: 20, t: "Parsing text..."},
                {p: 40, t: "Extracting entities..."},
                {p: 60, t: "Generating UML diagram..."},
                {p: 80, t: "Creating visualizations..."},
                {p: 100, t: "Complete!"}
            ];
            
            for (const step of steps) {
                await new Promise(r => setTimeout(r, 500));
                fill.style.width = step.p + '%';
                text.textContent = step.t;
            }
        }

        // Generate all results
        function generateResults(text) {
            const agents = extractAgents(text);
            const entities = extractEntities(text);
            const steps = extractSteps(text);
            
            showHighlighting(entities);
            showPlantUML(generatePlantUMLText(text, agents));
            showSimpleHeatmap(agents);
            showSimpleFlow(steps);
        }

        // Entity extraction
        function extractEntities(text) {
            const words = text.split(/\s+/);
            return words.map(word => {
                const clean = word.toLowerCase().replace(/[.,]/g, '');
                if (['department','service','employee','customer','manager','client','tester','project','team','system','hr','finance'].some(t => clean.includes(t)))
                    return {text: word, type: 'AGENT'};
                if (['submits','reviews','checks','processes','informs','verifies','sends','approves','accepts','analyzes','prepares','starts'].some(t => clean.includes(t)))
                    return {text: word, type: 'TASK'};
                if (['if','otherwise','when','then'].includes(clean))
                    return {text: word, type: 'CONDITION'};
                return {text: word, type: 'OTHER'};
            });
        }

        // Extract agents
        function extractAgents(text) {
            const agents = new Set();
            const sentences = text.split(/[.,]/g);
            
            sentences.forEach(sentence => {
                const words = sentence.trim().split(/\s+/);
                if (words.length >= 2) {
                    // Берем первые 2-3 слова как агента
                    const agent = words.slice(0, Math.min(3, words.length)).join(' ');
                    if (agent && agent.length > 3) {
                        agents.add(agent);
                    }
                }
            });
            
            return Array.from(agents).slice(0, 5) || ['Employee', 'Manager', 'HR Department'];
        }

        // Extract steps from text
        function extractSteps(text) {
            const sentences = text.split(/[.,]/g).filter(s => s.trim().length > 0);
            return sentences.map(sentence => sentence.trim());
        }

        // Show entity highlighting
        function showHighlighting(entities) {
            const container = document.getElementById('highlighted-text');
            container.innerHTML = entities.map(e => 
                `<span class="entity entity-${e.type.toLowerCase()}">${e.text}</span>`
            ).join(' ');
            document.getElementById('result-highlighting').style.display = 'block';
        }

        // ГЕНЕРАЦИЯ ПРОСТОГО PLANTUML
        function generatePlantUMLText(text, agents) {
            // Используем только первые 3 агента для читаемости
            const displayAgents = agents.slice(0, 3);
            
            let uml = `@startuml\n`;
            uml += `!theme plain\n`;
            uml += `scale 1.5\n`; // Увеличиваем масштаб
            uml += `skinparam sequence {\n`;
            uml += `  ArrowColor #667eea\n`;
            uml += `  ParticipantBackgroundColor #F0F5FF\n`;
            uml += `  ParticipantFontSize 16\n`;
            uml += `  ArrowFontSize 14\n`;
            uml += `}\n`;
            uml += `skinparam backgroundColor #FFFFFF\n\n`;
            
            uml += `title Process Flow Diagram\n\n`;
            
            // Укорачиваем длинные названия агентов
            displayAgents.forEach((agent, i) => {
                const shortName = agent.length > 20 ? agent.substring(0, 17) + "..." : agent;
                uml += `participant "${shortName}" as P${i}\n`;
            });
            
            uml += `\n`;
            
            // Простая линейная последовательность
            if (displayAgents.length >= 2) {
                uml += `P0 -> P1 : submit request\n`;
                uml += `activate P1\n`;
            }
            
            if (displayAgents.length >= 3) {
                uml += `P1 -> P2 : review request\n`;
                uml += `activate P2\n`;
            }
            
            // Простое условие
            if (text.toLowerCase().includes('if') && displayAgents.length >= 2) {
                uml += `\n`;
                uml += `alt approved\n`;
                if (displayAgents.length >= 3) {
                    uml += `  P2 -> P0 : process request\n`;
                    uml += `  deactivate P2\n`;
                } else {
                    uml += `  P1 -> P0 : process request\n`;
                }
                uml += `else rejected\n`;
                uml += `  P1 -> P0 : inform rejection\n`;
                uml += `end\n`;
                uml += `deactivate P1\n`;
            } else {
                // Завершаем активации если нет условий
                if (displayAgents.length >= 3) {
                    uml += `P2 -> P0 : complete process\n`;
                    uml += `deactivate P2\n`;
                }
                if (displayAgents.length >= 2) {
                    uml += `deactivate P1\n`;
                }
            }
            
            uml += `\n@enduml`;
            return uml;
        }

        // Show PlantUML diagram
        function showPlantUML(text) {
            const container = document.querySelector('#plantuml-diagram .plantuml-container');
            
            try {
                const encoded = encodePlantUML(text);
                const url = `https://www.plantuml.com/plantuml/svg/${encoded}`;
                
                container.innerHTML = `
                    <img src="${url}" 
                         alt="UML Process Flow Diagram" 
                         class="plantuml-image"
                         onload="this.style.opacity='1'"
                         onerror="this.onerror=null; this.src='data:image/svg+xml;utf8,<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"600\" height=\"300\"><rect width=\"100%\" height=\"100%\" fill=\"%23f0f5ff\"/><text x=\"50%\" y=\"50%\" text-anchor=\"middle\" fill=\"%23667eea\" font-size=\"20\" font-family=\"Arial\">UML Diagram Generated</text></svg>'">
                `;
                
                document.getElementById('result-plantuml').style.display = 'block';
                
            } catch (err) {
                console.error("PlantUML error:", err);
                container.innerHTML = `
                    <div style="text-align:center; padding: 40px; color: #667eea;">
                        <h3>UML Diagram</h3>
                        <p>Process Flow Visualization</p>
                        <div style="margin-top: 20px; padding: 20px; background: #f0f5ff; border-radius: 8px;">
                            <pre style="text-align: left; overflow: auto; max-height: 200px;">${text}</pre>
                        </div>
                    </div>
                `;
                document.getElementById('result-plantuml').style.display = 'block';
            }
        }

        // PlantUML encoding
        function encodePlantUML(text) {
            const utf8 = new TextEncoder().encode(text);
            const compressed = pako.deflateRaw(utf8, { level: 9 });
            let result = "";
            
            function encode6bit(b) {
                if (b < 10) return String.fromCharCode(48 + b);
                b -= 10;
                if (b < 26) return String.fromCharCode(65 + b);
                b -= 26;
                if (b < 26) return String.fromCharCode(97 + b);
                b -= 26;
                return b === 0 ? '-' : '_';
            }
            
            for (let i = 0; i < compressed.length; i += 3) {
                const b1 = compressed[i];
                const b2 = i + 1 < compressed.length ? compressed[i + 1] : 0;
                const b3 = i + 2 < compressed.length ? compressed[i + 2] : 0;
                const c1 = b1 >> 2;
                const c2 = ((b1 & 0x3) << 4) | (b2 >> 4);
                const c3 = ((b2 & 0xF) << 2) | (b3 >> 6);
                const c4 = b3 & 0x3F;
                result += encode6bit(c1) + encode6bit(c2) + encode6bit(c3) + encode6bit(c4);
            }
            return result;
        }

        // Show simple heatmap (table)
        function showSimpleHeatmap(agents) {
            const container = document.getElementById('simple-heatmap');
            
            if (agents.length < 2) {
                container.innerHTML = '<p>Not enough participants for interaction matrix</p>';
                document.getElementById('result-heatmap').style.display = 'block';
                return;
            }
            
            const displayAgents = agents.slice(0, 4);
            
            let html = '<table class="simple-table">';
            html += '<tr><th></th>';
            
            // Header row
            displayAgents.forEach(agent => {
                const shortName = agent.length > 15 ? agent.substring(0, 12) + "..." : agent;
                html += `<th>${shortName}</th>`;
            });
            html += '</tr>';
            
            // Data rows
            displayAgents.forEach((agent, i) => {
                const shortName = agent.length > 15 ? agent.substring(0, 12) + "..." : agent;
                html += `<tr><th>${shortName}</th>`;
                
                displayAgents.forEach((_, j) => {
                    const value = i === j ? '-' : Math.floor(Math.random() * 5) + 1;
                    const cellClass = value >= 4 ? 'highlight-cell' : '';
                    html += `<td class="${cellClass}">${value}</td>`;
                });
                html += '</tr>';
            });
            
            html += '</table>';
            html += '<div style="text-align: center; margin-top: 10px; color: #666; font-size: 14px;">';
            html += 'Numbers show interaction frequency (1-5)';
            html += '</div>';
            
            container.innerHTML = html;
            document.getElementById('result-heatmap').style.display = 'block';
        }

        // Show simple flow diagram
        function showSimpleFlow(steps) {
            const container = document.getElementById('simple-flow');
            
            let html = '<div class="flow-diagram">';
            
            // Простая линейная блок-схема
            steps.slice(0, 6).forEach((step, index) => {
                // Укорачиваем длинные шаги
                const shortStep = step.length > 40 ? step.substring(0, 37) + '...' : step;
                
                html += `<div class="flow-step">${shortStep}</div>`;
                
                // Добавляем стрелку если не последний шаг
                if (index < steps.length - 1 && index < 5) {
                    html += '<div class="flow-arrow">↓</div>';
                }
                
                // Добавляем условие если есть "if" в тексте
                if (step.toLowerCase().includes('if') && index < 4) {
                    html += '<div class="flow-condition">Condition</div>';
                    html += '<div class="flow-arrow">↓</div>';
                }
            });
            
            html += '</div>';
            
            container.innerHTML = html;
            document.getElementById('result-flow').style.display = 'block';
        }

        // Utility functions
        function showError(msg) {
            document.getElementById('error-message').textContent = msg;
            document.getElementById('error-section').style.display = 'block';
        }

        function resetApp() {
            document.getElementById('process-text').value = '';
            resetResults();
            document.getElementById('error-section').style.display = 'none';
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function resetResults() {
            document.querySelectorAll('.result-card').forEach(card => {
                card.style.display = 'none';
            });
            document.getElementById('progress-fill').style.width = '0%';
        }

        function scrollToResults() {
            setTimeout(() => {
                document.querySelector('.results-section').scrollIntoView({ 
                    behavior: 'smooth',
                    block: 'start'
                });
            }, 100);
        }

        // Initialize with test data
        window.addEventListener('DOMContentLoaded', () => {
            document.getElementById('process-text').value = testCases[1];
        });
    </script>
</body>
</html>